#!/bin/bash

. /etc/rc.conf
. /etc/rc.d/functions

_logDir="/var/log/minecraft-server"
_runDir="/var/run/minecraft-server"
_srvDir="/srv/minecraft"

case "$1" in
  start)
    stat_busy "Starting minecraft-server"
    if [[ ! -f "$_runDir/server.pid" ]]; then
      cd "$_srvDir"
      if [[ ! -d "$_runDir" ]]; then
        mkdir -p "$_runDir"
        chown minecraft:minecraft "$_runDir"
      fi
      su minecraft -c "source /etc/profile && detachtty --dribble-file $_logDir/server_stdout.log --log-file $_logDir/detachtty.log --pid-file $_runDir/server.pid $_runDir/socket /usr/bin/minecraft-server nogui" &&
      add_daemon minecraft-server &&
      stat_done || stat_fail
    else
      stat_fail
    fi
    ;;
  stop)
    stat_busy "Stopping minecraft-server"
    if [[ ! -f "$_runDir/server.pid" ]]; then
      stat_fail
    else
      [[ -S "$_runDir/socket" ]] && expect - &> /dev/null << EOF
spawn attachtty "$_runDir/socket"
send "save-all\r"
expect "Save complete.$"
send "stop\r"
expect "Saving chunks"
EOF
      rm_daemon minecraft-server &&
      stat_done || stat_fail
    fi
    ;;
  restart)
    $0 stop
    sleep 1
    $0 start
    ;;
  status)
    stat_busy 'Checking minecraft-server status'
    ck_status minecraft-server
    ;;
  *)
    echo "usage: $0 {start|stop|restart|status}"
esac
exit 0
